<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Điểm danh - Scan QR</title>
  <style>
    body{font-family: Arial, sans-serif; padding: 16px; max-width: 640px; margin:auto;}
    input{width:100%; padding:10px; margin:8px 0; box-sizing:border-box;}
    button{padding:10px 16px; margin:8px 0;}
    .small {font-size:0.9em;color:#555;}
  </style>
</head>
<body>
  <h2>Điểm danh</h2>
  <div class="small">Mở link này từ điện thoại, bật vị trí và gửi thông tin đầy đủ.</div>

  <label>Họ & tên</label>
  <input id="fullname" placeholder="Họ & tên" />

  <label>Mã sinh viên</label>
  <input id="mssv" placeholder="Mã sinh viên / Mã học viên" />

  <label>Email (tùy chọn)</label>
  <input id="email" placeholder="Email (nếu có)" />

  <label>Session</label>
  <input id="session" readonly />

  <div style="margin-top:8px;">
    <button id="btnGetLoc">Lấy vị trí</button>
    <span id="locStatus" class="small">(Chưa có vị trí)</span>
  </div>

  <div style="margin-top:12px;">
    <button id="btnSubmit">Gửi điểm danh</button>
  </div>

  <div id="result" style="margin-top:12px;"></div>

<script>
/* -------- CONFIG ---------- */
const WEBHOOK_URL = "https://make.powerautomate.com/environments/Default-fc4a97f7-7b14-45b7-bf4a-ef4e95696c50/flows/7d6d22c3-c6f0-4060-8961-da36f7bc6dee/details";  
const API_TOKEN = "gachanngan2804"; // token bạn đã cung cấp
/* -------------------------- */

function getQueryParam(name) {
  return new URLSearchParams(window.location.search).get(name) || "";
}

// Haversine (metres)
function haversine(lat1, lon1, lat2, lon2) {
  function toRad(x){ return x * Math.PI / 180; }
  var R = 6371000;
  var dLat = toRad(lat2 - lat1);
  var dLon = toRad(lon2 - lon1);
  var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
          Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
          Math.sin(dLon/2) * Math.sin(dLon/2);
  var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return Math.round(R * c);
}

// Init session from URL
document.getElementById('session').value = getQueryParam('session');
let tokenFromUrl = getQueryParam('token');

let lat="", lng="";

document.getElementById('btnGetLoc').addEventListener('click', function(){
  if (!navigator.geolocation) {
    alert('Trình duyệt không hỗ trợ vị trí');
    return;
  }
  document.getElementById('locStatus').innerText = 'Đang lấy vị trí...';
  navigator.geolocation.getCurrentPosition(function(p){
    lat = p.coords.latitude;
    lng = p.coords.longitude;
    document.getElementById('locStatus').innerText = 'Vị trí: ' + lat.toFixed(6) + ', ' + lng.toFixed(6);
  }, function(err){
    document.getElementById('locStatus').innerText = '(Không thể lấy vị trí: ' + (err.message || 'error') + ')';
    alert('Vui lòng bật vị trí (Location) và cho phép trang web truy cập vị trí.');
  }, { enableHighAccuracy: true, timeout: 15000 });
});

document.getElementById('btnSubmit').addEventListener('click', function(){
  const name = document.getElementById('fullname').value.trim();
  const mssv = document.getElementById('mssv').value.trim();
  const email = document.getElementById('email').value.trim();
  let session = document.getElementById('session').value.trim();
  if (!name) { alert('Vui lòng nhập Họ & tên'); return; }
  if (!mssv) { alert('Vui lòng nhập Mã sinh viên'); return; }
  if (!lat || !lng) { alert('Vui lòng bấm "Lấy vị trí" và bật quyền vị trí (Allow).'); return; }

  // Optional: kiểm tra khoảng cách đến tâm lớp
  const classLat = 21.209876;
  const classLng = 105.808822;
  const dist = haversine(lat, lng, classLat, classLng);
  const maxMeters = 150;
  if (dist > maxMeters) {
    if (!confirm("Bạn đang ở cách lớp " + dist + " m (vượt quá " + maxMeters + " m). Vẫn gửi?")) {
      return;
    }
  }

  // Gửi POST tới webhook
  const payload = {
    session: session,
    name: name,
    mssv: mssv,
    email: email,
    latitude: parseFloat(lat),
    longitude: parseFloat(lng),
    ua: navigator.userAgent,
    token: tokenFromUrl || API_TOKEN
  };

  document.getElementById('result').innerText = 'Đang gửi...';

  fetch(WEBHOOK_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': tokenFromUrl || API_TOKEN
    },
    body: JSON.stringify(payload)
  })
  .then(async res => {
    const txt = await res.text();
    if (res.ok) {
      document.getElementById('result').innerHTML = '<span style="color:green">Gửi thành công ✓</span>';
      document.getElementById('fullname').value = '';
      document.getElementById('mssv').value = '';
    } else {
      document.getElementById('result').innerHTML = '<span style="color:crimson">Lỗi: ' + res.status + ' — ' + txt + '</span>';
    }
  })
  .catch(err => {
    document.getElementById('result').innerHTML = '<span style="color:crimson">Lỗi gửi: ' + err.message + '</span>';
  });

});
</script>
</body>
</html>
