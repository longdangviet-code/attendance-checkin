<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ĐIỂM DANH </title>
  <style>
    body{font-family: Arial, sans-serif; padding: 16px; max-width: 720px; margin:centre; background:#f9f9f9;}
    .card{background:#fff;padding:16px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.06);}
    input, button {font-size:16px;}
    input{width:100%; padding:10px; margin:8px 0; box-sizing:border-box; border:1px solid #ddd; border-radius:6px;}
    button{padding:10px 16px; margin:8px 0; border-radius:6px; cursor:pointer; border:0; background:#0078d4; color:white;}
    .small {font-size:0.9em;color:#555;}
    #photoPreview img{max-width:220px; border:1px solid #ccc; padding:4px; border-radius:6px;}
    .danger{color:#b71c1c;}
  </style>
</head>
<body>
  <div class="card">
    <h2>Điểm danh (Ảnh + Vị trí)</h2>
    <div class="small">Mở link trên điện thoại, bật vị trí và chụp ảnh. Ứng dụng chỉ chấp nhận khi bạn ở trong bán kính <strong id="radiusText">100m</strong> quanh tọa độ lớp.</div>

    <label>Họ & tên</label>
    <input id="fullname" placeholder="Họ & tên" />

    <label>Mã sinh viên</label>
    <input id="mssv" placeholder="Mã sinh viên / Mã học viên" />

    <label>Email (tùy chọn)</label>
    <input id="email" placeholder="Email (nếu có)" />

    <label>Session</label>
    <input id="session" readonly />

    <label style="margin-top:8px;">Ảnh (bắt buộc) — chụp hoặc chọn ảnh</label>
    <input id="photoInput" type="file" accept="image/*" capture="environment" />
    <div id="photoPreview" style="margin-top:8px;"></div>
    <div id="photoHint" class="small" style="color:#666;margin-top:6px;">Ảnh sẽ được nén trước khi gửi (giữ quyền riêng tư).</div>

    <div style="margin-top:8px;">
      <button id="btnGetLoc">Lấy vị trí</button>
      <span id="locStatus" class="small">(Chưa có vị trí)</span>
    </div>

    <div style="margin-top:12px;">
      <button id="btnSubmit">Gửi điểm danh</button>
    </div>

    <div id="result" style="margin-top:12px;"></div>

    <hr style="margin-top:18px;">
    <div class="small">
      <strong>Ghi chú bảo mật:</strong> Ảnh và vị trí dùng để xác minh điểm danh. Hệ thống lưu ảnh lên SharePoint/OneDrive quản trị.
    </div>
  </div>

<script>
/* ====== CẤU HÌNH ====== */
const WEBHOOK_URL = "https://defaultfc4a97f77b1445b7bf4aef4e95696c.50.environment.api.powerplatform.com/powerautomate/automations/direct/workflows/993a9e1472c24fd7864f8a3d2d1a5b12/triggers/manual/paths/invoke?api-version=1";
const API_TOKEN   = "gachanngan2804"; 
const CLASS_LAT   = 21.209876;   // tọa độ lớp
const CLASS_LNG   = 105.808822;
const RADIUS_M    = 200;         // bán kính hợp lệ (m)

document.getElementById('radiusText').innerText = RADIUS_M + "m";
document.getElementById('session').value = new URLSearchParams(location.search).get("session") || "";

/* ====== HÀM PHỤ ====== */
function toRad(x){return x*Math.PI/180;}
function haversine(lat1,lon1,lat2,lon2){
  const R=6371000,dLat=toRad(lat2-lat1),dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return Math.round(R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
}

/* ====== BIẾN TOÀN CỤC ====== */
let lat="", lng="", photoBase64="";

/* ====== XỬ LÝ ẢNH ====== */
async function resizeImageToBase64(file,maxW=1024,quality=0.7){
  return new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onload=e=>{
      const img=new Image();
      img.onload=()=>{
        const scale=Math.min(1,maxW/img.width);
        const canvas=document.createElement("canvas");
        canvas.width=img.width*scale; canvas.height=img.height*scale;
        const ctx=canvas.getContext("2d"); ctx.drawImage(img,0,0,canvas.width,canvas.height);
        resolve(canvas.toDataURL("image/jpeg",quality).split(",")[1]);
      };
      img.onerror=reject; img.src=e.target.result;
    };
    reader.onerror=reject; reader.readAsDataURL(file);
  });
}

document.getElementById("photoInput").addEventListener("change",async e=>{
  const f=e.target.files?.[0]; const preview=document.getElementById("photoPreview");
  if(!f){photoBase64=""; preview.innerHTML=""; return;}
  if(f.size>6*1024*1024){alert("Ảnh quá lớn (>6MB)"); e.target.value=""; return;}
  preview.innerHTML="Đang xử lý ảnh...";
  try{
    photoBase64=await resizeImageToBase64(f,1024,0.75);
    preview.innerHTML=`<img src="data:image/jpeg;base64,${photoBase64}" alt="preview"/>`;
  }catch(err){alert("Lỗi xử lý ảnh"); console.error(err);}
});

/* ====== LẤY VỊ TRÍ ====== */
document.getElementById("btnGetLoc").addEventListener("click",()=>{
  if(!navigator.geolocation){alert("Trình duyệt không hỗ trợ định vị"); return;}
  const status=document.getElementById("locStatus");
  status.innerText="Đang lấy vị trí...";
  navigator.geolocation.getCurrentPosition(
    p=>{
      lat=p.coords.latitude; lng=p.coords.longitude;
      status.innerText=`Vị trí: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    },
    err=>{
      status.innerText="Không lấy được vị trí"; 
      alert("Vui lòng bật GPS và cho phép truy cập vị trí");
    },
    {enableHighAccuracy:true,timeout:15000}
  );
});

/* ====== GỬI DỮ LIỆU ====== */
document.getElementById("btnSubmit").addEventListener("click",async ()=>{
  const name=document.getElementById("fullname").value.trim();
  const mssv=document.getElementById("mssv").value.trim();
  const email=document.getElementById("email").value.trim();
  const session=document.getElementById("session").value.trim();
  const result=document.getElementById("result");

  if(!name||!mssv){alert("Vui lòng nhập Họ tên và Mã sinh viên");return;}
  if(!photoBase64){alert("Vui lòng chọn/chụp ảnh");return;}
  if(!lat||!lng){alert("Vui lòng bấm 'Lấy vị trí'");return;}

  const dist=haversine(lat,lng,CLASS_LAT,CLASS_LNG);
  if(dist>RADIUS_M){alert(`Bạn cách lớp ${dist}m (vượt ${RADIUS_M}m)`);return;}

  const payload={
    session,name,mssv,email,latitude:lat,longitude:lng,
    userAgent:navigator.userAgent,token:API_TOKEN,photo:photoBase64
  };

  result.innerText="Đang gửi...";
  try{
    const res=await fetch(WEBHOOK_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json","x-api-key":API_TOKEN},
      body:JSON.stringify(payload)
    });
    const txt=await res.text();
    if(res.ok){
      result.innerHTML="<span style='color:green'>✅ Gửi thành công!</span>";
      document.getElementById("fullname").value="";
      document.getElementById("mssv").value="";
      document.getElementById("photoInput").value="";
      document.getElementById("photoPreview").innerHTML="";
      photoBase64="";
    }else{
      result.innerHTML=`<span style='color:red'>❌ Lỗi ${res.status}: ${txt}</span>`;
    }
  }catch(err){
    result.innerHTML=`<span style='color:red'>⚠️ Lỗi gửi: ${err.message}</span>`;
  }
});
</script>
</body>
</html>
