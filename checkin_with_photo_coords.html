<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ƒêI·ªÇM DANH </title>
  <style>
    body{font-family: Arial, sans-serif; padding: 16px; max-width: 720px; margin:centre; background:#f9f9f9;}
    .card{background:#fff;padding:16px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.06);}
    input, button {font-size:16px;}
    input{width:100%; padding:10px; margin:8px 0; box-sizing:border-box; border:1px solid #ddd; border-radius:6px;}
    button{padding:10px 16px; margin:8px 0; border-radius:6px; cursor:pointer; border:0; background:#0078d4; color:white;}
    .small {font-size:0.9em;color:#555;}
    #photoPreview img{max-width:220px; border:1px solid #ccc; padding:4px; border-radius:6px;}
    .danger{color:#b71c1c;}
  </style>
</head>
<body>
  <div class="card">
    <h2>ƒêi·ªÉm danh (·∫¢nh + V·ªã tr√≠)</h2>
    <div class="small">M·ªü link tr√™n ƒëi·ªán tho·∫°i, b·∫≠t v·ªã tr√≠ v√† ch·ª•p ·∫£nh. ·ª®ng d·ª•ng ch·ªâ ch·∫•p nh·∫≠n khi b·∫°n ·ªü trong b√°n k√≠nh <strong id="radiusText">100m</strong> quanh t·ªça ƒë·ªô l·ªõp.</div>

    <label>H·ªç & t√™n</label>
    <input id="fullname" placeholder="H·ªç & t√™n" />

    <label>M√£ sinh vi√™n</label>
    <input id="mssv" placeholder="M√£ sinh vi√™n / M√£ h·ªçc vi√™n" />

    <label>Email (t√πy ch·ªçn)</label>
    <input id="email" placeholder="Email (n·∫øu c√≥)" />

    <label>Session</label>
    <input id="session" readonly />

    <label style="margin-top:8px;">·∫¢nh (b·∫Øt bu·ªôc) ‚Äî ch·ª•p ho·∫∑c ch·ªçn ·∫£nh</label>
    <input id="photoInput" type="file" accept="image/*" capture="environment" />
    <div id="photoPreview" style="margin-top:8px;"></div>
    <div id="photoHint" class="small" style="color:#666;margin-top:6px;">·∫¢nh s·∫Ω ƒë∆∞·ª£c n√©n tr∆∞·ªõc khi g·ª≠i (gi·ªØ quy·ªÅn ri√™ng t∆∞).</div>

    <div style="margin-top:8px;">
      <button id="btnGetLoc">L·∫•y v·ªã tr√≠</button>
      <span id="locStatus" class="small">(Ch∆∞a c√≥ v·ªã tr√≠)</span>
    </div>

    <div style="margin-top:12px;">
      <button id="btnSubmit">G·ª≠i ƒëi·ªÉm danh</button>
    </div>

    <div id="result" style="margin-top:12px;"></div>

    <hr style="margin-top:18px;">
    <div class="small">
      <strong>Ghi ch√∫ b·∫£o m·∫≠t:</strong> ·∫¢nh v√† v·ªã tr√≠ d√πng ƒë·ªÉ x√°c minh ƒëi·ªÉm danh. H·ªá th·ªëng l∆∞u ·∫£nh l√™n SharePoint/OneDrive qu·∫£n tr·ªã.
    </div>
  </div>

<script>
/* ====== C·∫§U H√åNH NG·∫ÆN ======
  - Thay classLat/classLng b·∫±ng t·ªça ƒë·ªô l·ªõp (l·∫•y t·ª´ Google Maps).
  - WEBHOOK_URL l√† endpoint Power Automate (When an HTTP request is received).
  - API_TOKEN l√† token b√≠ m·∫≠t (ph·∫£i kh·ªõp v·ªõi Flow).
  - RADIUS_METERS: b√°n k√≠nh h·ª£p l·ªá (100m).
*/
const WEBHOOK_URL = "https://defaultfc4a97f77b1445b7bf4aef4e95696c.50.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/993a9e1472c24fd7864f8a3d2d1a5b12/triggers/manual/paths/invoke?api-version=1";
const API_TOKEN = "gachanngan2804";

// Thay t·ªça ƒë·ªô l·ªõp t·∫°i ƒë√¢y (v√≠ d·ª•: 10.762622, 106.660172)
const classLat = 21.209876;
const classLng = 105.808822;

// B√°n k√≠nh h·ª£p l·ªá (ƒë∆°n v·ªã: m√©t)
const RADIUS_METERS = 200;
document.getElementById('radiusText').innerText = RADIUS_METERS + 'm';

function getQueryParam(name) {
  return new URLSearchParams(window.location.search).get(name) || "";
}

// Haversine (metres)
function haversine(lat1, lon1, lat2, lon2) {
  function toRad(x){ return x * Math.PI / 180; }
  var R = 6371000;
  var dLat = toRad(lat2 - lat1);
  var dLon = toRad(lon2 - lon1);
  var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
          Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
          Math.sin(dLon/2) * Math.sin(dLon/2);
  var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return Math.round(R * c);
}

/* ===== LOCATION & SESSION ===== */
document.getElementById('session').value = getQueryParam('session');
let tokenFromUrl = getQueryParam('token');

let lat = "", lng = "";

/* ===== IMAGE HANDLING ===== */
let photoBase64 = ""; // store base64 payload (without data:image/... prefix)

// Resize & compress image using canvas, return Promise resolves base64 string without prefix
function resizeImageFileToBase64(file, maxWidth = 1024, quality = 0.7) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = function(event) {
      const img = new Image();
      img.onload = function() {
        const scale = Math.min(1, maxWidth / img.width);
        const canvas = document.createElement('canvas');
        canvas.width = Math.round(img.width * scale);
        canvas.height = Math.round(img.height * scale);
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        const dataURL = canvas.toDataURL('image/jpeg', quality);
        const base64 = dataURL.split(',')[1];
        resolve(base64);
      };
      img.onerror = function(e) { reject(e); };
      img.src = event.target.result;
    };
    reader.onerror = function(err) { reject(err); };
    reader.readAsDataURL(file);
  });
}

document.getElementById('photoInput').addEventListener('change', async function(e) {
  const f = e.target.files && e.target.files[0];
  const preview = document.getElementById('photoPreview');
  if (!f) {
    photoBase64 = "";
    preview.innerHTML = "";
    return;
  }
  const maxFileMB = 6;
  if (f.size > maxFileMB * 1024 * 1024) {
    alert('·∫¢nh qu√° l·ªõn (>' + maxFileMB + ' MB). Vui l√≤ng ch·ªçn ·∫£nh kh√°c ho·∫∑c ch·ª•p l·∫°i nh·ªè h∆°n.');
    e.target.value = ''; photoBase64 = ""; preview.innerHTML = ""; return;
  }
  try {
    preview.innerHTML = 'ƒêang x·ª≠ l√Ω ·∫£nh...';
    const base64 = await resizeImageFileToBase64(f, 1024, 0.75);
    photoBase64 = base64;
    preview.innerHTML = '<img src="data:image/jpeg;base64,' + base64 + '" alt="preview" />';
  } catch(err) {
    console.error(err);
    alert('L·ªói x·ª≠ l√Ω ·∫£nh: ' + (err.message || err));
    photoBase64 = ""; preview.innerHTML = "";
  }
});

/* ===== GET LOCATION ===== */
document.getElementById('btnGetLoc').addEventListener('click', function(){
  if (!navigator.geolocation) {
    alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ v·ªã tr√≠');
    return;
  }
  document.getElementById('locStatus').innerText = 'ƒêang l·∫•y v·ªã tr√≠...';
  navigator.geolocation.getCurrentPosition(function(p){
    lat = p.coords.latitude;
    lng = p.coords.longitude;
    document.getElementById('locStatus').innerText = 'V·ªã tr√≠: ' + lat.toFixed(6) + ', ' + lng.toFixed(6);
  }, function(err){
    document.getElementById('locStatus').innerText = '(Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠: ' + (err.message || 'error') + ')';
    alert('Vui l√≤ng b·∫≠t v·ªã tr√≠ (Location) v√† cho ph√©p trang web truy c·∫≠p v·ªã tr√≠.');
  }, { enableHighAccuracy: true, timeout: 15000 });
});

/* ===== SUBMIT ===== */
document.getElementById('btnSubmit').addEventListener('click', function(){
  const name = document.getElementById('fullname').value.trim();
  const mssv = document.getElementById('mssv').value.trim();
  const email = document.getElementById('email').value.trim();
  let session = document.getElementById('session').value.trim();
  if (!name) { alert('Vui l√≤ng nh·∫≠p H·ªç & t√™n'); return; }
  if (!mssv) { alert('Vui l√≤ng nh·∫≠p M√£ sinh vi√™n'); return; }
  if (!lat || !lng) { alert('Vui l√≤ng b·∫•m "L·∫•y v·ªã tr√≠" v√† b·∫≠t quy·ªÅn v·ªã tr√≠ (Allow).'); return; }
  if (!photoBase64) { alert('Vui l√≤ng ch·ª•p ho·∫∑c ch·ªçn ·∫£nh tr∆∞·ªõc khi g·ª≠i.'); return; }

  // distance check
  const dist = haversine(lat, lng, classLat, classLng);
  if (dist > RADIUS_METERS) {
    alert("B·∫°n ƒëang ·ªü c√°ch l·ªõp " + dist + " m (v∆∞·ª£t qu√° " + RADIUS_METERS + " m). Kh√¥ng th·ªÉ ƒëi·ªÉm danh.");
    return;
  }

  const payload = {
    session: session,
    name: name,
    mssv: mssv,
    email: email,
    latitude: parseFloat(lat),
    longitude: parseFloat(lng),
    ua: navigator.userAgent,
    token: tokenFromUrl || API_TOKEN,
    photo: photoBase64
  };

  document.getElementById('result').innerText = 'ƒêang g·ª≠i...';

  fetch(WEBHOOK_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': tokenFromUrl || API_TOKEN
    },
    body: JSON.stringify(payload)
  })
  .then(async res => {
    const txt = await res.text();
    if (res.ok) {
      document.getElementById('result').innerHTML = '<span style="color:green">G·ª≠i th√†nh c√¥ng ‚úì</span>';
      document.getElementById('fullname').value = '';
      document.getElementById('mssv').value = '';
      document.getElementById('photoInput').value = '';
      document.getElementById('photoPreview').innerHTML = '';
      photoBase64 = "";
    } else {
      document.getElementById('result').innerHTML = '<span class="danger">L·ªói: ' + res.status + ' ‚Äî ' + txt + '</span>';
    }
  })
  .catch(err => {
    document.getElementById('result').innerHTML = '<span class="danger">L·ªói g·ª≠i: ' + err.message + '</span>';
  });

});
</script>
</body>
</html>
/**
 * H√†m n√†y ch·ªãu tr√°ch nhi·ªám g·ª≠i d·ªØ li·ªáu ch·∫•m c√¥ng ƒë·∫øn Power Automate.
 * @param {string} employeeId - ID c·ªßa nh√¢n vi√™n (v√≠ d·ª•: 'EMP001').
 * @param {number} latitude - Vƒ© ƒë·ªô GPS.
 * @param {number} longitude - Kinh ƒë·ªô GPS.
 * @param {string} base64ImageString - Chu·ªói base64 c·ªßa h√¨nh ·∫£nh (ph·∫£i bao g·ªìm c·∫£ ph·∫ßn ƒë·∫ßu, v√≠ d·ª•: 'data:image/jpeg;base64,...').
 */
async function sendCheckinToPowerAutomate(employeeId, latitude, longitude, base64ImageString) {
    // üëá QUAN TR·ªåNG: D√°n URL c·ªßa Power Automate c·ªßa b·∫°n v√†o ƒë√¢y!
    const powerAutomateUrl = 'https://defaultfc4a97f77b1445b7bf4aef4e95696c.50.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/993a9e1472c24fd7864f8a3d2d1a5b12/triggers/manual/paths/invoke?api-version=1';

    // 1. Chu·∫©n b·ªã ƒë·ªëi t∆∞·ª£ng d·ªØ li·ªáu ƒë·ªÉ g·ª≠i ƒëi.
    // T√™n c√°c thu·ªôc t√≠nh (employeeId, timestamp,...) ph·∫£i kh·ªõp ch√≠nh x√°c
    // v·ªõi nh·ªØng g√¨ b·∫°n ƒë√£ ƒë·ªãnh nghƒ©a trong JSON Schema c·ªßa Power Automate.
    const checkinData = {
        employeeId: employeeId,
        timestamp: new Date().toISOString(), // T·ª± ƒë·ªông l·∫•y th·ªùi gian hi·ªán t·∫°i theo chu·∫©n ISO
        latitude: latitude,
        longitude: longitude,
        photo: base64ImageString
    };

    // Hi·ªÉn th·ªã th√¥ng b√°o cho ng∆∞·ªùi d√πng bi·∫øt l√† ƒëang x·ª≠ l√Ω
    alert('ƒêang g·ª≠i d·ªØ li·ªáu ch·∫•m c√¥ng, vui l√≤ng ƒë·ª£i...');

    try {
        // 2. G·ª≠i y√™u c·∫ßu b·∫±ng h√†m fetch
        const response = await fetch(powerAutomateUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(checkinData) // Chuy·ªÉn ƒë·ªëi t∆∞·ª£ng JavaScript th√†nh chu·ªói JSON
        });

        // 3. X·ª≠ l√Ω ph·∫£n h·ªìi t·ª´ Power Automate
        if (response.ok) { // response.ok l√† true n·∫øu HTTP status l√† 200-299
            // N·∫øu b·∫°n c·∫•u h√¨nh Power Automate tr·∫£ v·ªÅ JSON
            const result = await response.json();
            console.log('Ph·∫£n h·ªìi th√†nh c√¥ng:', result);
            alert(`Th√†nh c√¥ng: ${result.message}`); // Hi·ªÉn th·ªã th√¥ng b√°o t·ª´ Flow

            // --- GHI CH√ö ---
            // N·∫øu b·∫°n c·∫•u h√¨nh Power Automate tr·∫£ v·ªÅ Text ƒë∆°n gi·∫£n, h√£y d√πng d√≤ng sau:
            // const resultText = await response.text();
            // alert(resultText);

        } else {
            // X·ª≠ l√Ω l·ªói t·ª´ server (v√≠ d·ª•: Power Automate b·ªã l·ªói)
            const errorText = await response.text();
            console.error('L·ªói t·ª´ Power Automate:', response.status, errorText);
            alert(`G·ª≠i th·∫•t b·∫°i! L·ªói: ${response.status}. Vui l√≤ng th·ª≠ l·∫°i.`);
        }

    } catch (error) {
        // X·ª≠ l√Ω l·ªói m·∫°ng (v√≠ d·ª•: m·∫•t k·∫øt n·ªëi internet)
        console.error('L·ªói m·∫°ng ho·∫∑c l·ªói khi g·ª≠i y√™u c·∫ßu:', error);
        alert('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß. Vui l√≤ng ki·ªÉm tra l·∫°i ƒë∆∞·ªùng truy·ªÅn internet v√† th·ª≠ l·∫°i.');
    }
}
